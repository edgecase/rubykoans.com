!!! 5
%html
  %head
    %title Learn Ruby with the EdgeCase Ruby Koans
    %meta{ :name => 'description', :content => 'Learn Ruby with the EdgeCase Ruby Koans' }
    %meta{ :name => 'keywords',    :content => 'ruby' }
    %meta{ :name => 'apple-mobile-web-app-capable', :content => 'yes' }
    %meta{ :name => 'apple-mobile-web-app-status-bar-style', :content => 'black' }
    %link{ :rel  => 'apple-touch-icon', :href => '/apple_favicon.png' }
    %link{ :rel  => 'shortcut icon',    :href => '/favicon.ico', :type => 'image/x-icon' }
    %link{ :rel  => 'stylesheet', :media => 'screen', :type => 'text/css', :href => '/stylesheets/reset.css' }
    %link{ :rel  => 'stylesheet', :media => 'screen', :type => 'text/css', :href => '/stylesheets/screen.css' }
    %link{ :rel  => 'stylesheet', :media => 'only screen and (max-width: 480px), only screen and (max-device-width: 480px)', :type => 'text/css', :href => '/stylesheets/mobile.css' }
    %link{ :rel  => 'stylesheet', :media => '(min-device-width: 768px) and (max-device-width: 1024px)', :type => 'text/css', :href => '/stylesheets/ipad.css' }

    %script{ :type => 'text/javascript', :src => 'http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js' }
    :javascript
      function iPhone(){ return (navigator.userAgent.match(/iPhone/i)) || (navigator.userAgent.match(/iPod/i)); }
      function setBodyClass(){ document.body.className = (document.documentElement.clientWidth<=940) ? 'small' : 'large'; }

      (function($){
        $.fn.boldSelectedElement = function(i) {
          $(this).css('font-weight', 'normal').eq(i).css('font-weight', 'bold');
        };

        $.fn.highlightVisibleAnchor = function() {
          var $this = $(this),
              anchors = $this.map(function() {return $(this).attr('href'); }),
              anchorPositions = $.map(anchors, function(a){return $(a).offset().top; });

          function currentIndex(sections) {
            var scrollPosition = $(window).scrollTop(),
                i=0,
                inSection = false;

            while(!inSection) {
              i++;
              if(sections[i-1] > scrollPosition) {
                i = 1;
                inSection = true;
              } else if (i >  sections[sections.length-1]) {
                i = sections.length;
                inSection = true;
              } else {
                inSection = sections[i-1] <= scrollPosition && scrollPosition < sections[i];
              }
            }

            return i-1;
          }

          $(this).boldSelectedElement(currentIndex(anchorPositions));

          $(window).scroll(function() {
            $this.boldSelectedElement(currentIndex(anchorPositions));
          });
        };


        $.fn.scrollToAnchor = function() {
          return this.click(function(e) {
            if(iPhone()) { return; }

            e.preventDefault();
            var targetSection = $($(this).attr('href'));
            var scrollTo      = targetSection.offset().top;
            $('html,body').animate({scrollTop: scrollTo});
          });
        };


        $(function(){
          setBodyClass();
          $(window).resize(setBodyClass);
          $('#sidebar ol a').scrollToAnchor().highlightVisibleAnchor();

          $('.email_address').each(function() {
            var address   = $(this).text().replace(' [at] ', '@').replace(' [dot] ', '.');
            var emailLink = '<a href="mailto:' + address + '">' + address + '</a>';

            $(this).replaceWith(emailLink);
          });
        });
      })(jQuery);
    %script{ :type => 'text/javascript', :src => 'http://use.typekit.com/bsl0mwg.js' }
    %script{ :type => 'text/javascript' } try{Typekit.load();}catch(e){}

    <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

  %body
    #top_line
    #main_content
      = yield

    :javascript
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-18201694-1']);
        _gaq.push(['_setDomainName', '.rubykoans.com']);
        _gaq.push(['_trackPageview']);

        (function() {
          var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
          ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
          var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
